<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¶ ç‹—å‰©å…¨ç»´åº¦ä½œæˆ˜ç»ˆç«¯</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Menlo', 'Monaco', 'Courier New', monospace; }
        .up { color: #22c55e; }
        .down { color: #ef4444; }
        .flash { animation: flash-animation 1s infinite; }
        @keyframes flash-animation {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // ==========================
        // æ ¸å¿ƒé…ç½®å‚æ•° (ä¸ Python ä¿æŒä¸€è‡´)
        // ==========================
        const CONFIG = {
            SYMBOL: "ETHUSDT",
            PRICE_TOLERANCE: 12,
            COOLDOWN_MINUTES: 8,
            SCAN_INTERVAL: 5000, // 5ç§’
            SL_OFFSET: 8,
            PROFIT_RATIO: 2.0
        };

        const INTERVALS = ["1m", "3m", "5m", "15m", "30m", "1h"];

        // ==========================
        // æ•°å­¦è®¡ç®—å·¥å…·å‡½æ•° (ç¿»è¯‘è‡ª Python)
        // ==========================
        const calcRSI = (closes, period = 14) => {
            if (closes.length < period) return 50;
            
            // è®¡ç®—æ¶¨è·Œå¹…
            let gains = [];
            let losses = [];
            
            for (let i = 1; i < closes.length; i++) {
                const delta = closes[i] - closes[i - 1];
                gains.push(delta > 0 ? delta : 0);
                losses.push(delta < 0 ? -delta : 0);
            }

            // å–æœ€å period ä¸ªæ•°æ®
            const recentGains = gains.slice(-period);
            const recentLosses = losses.slice(-period);

            const avgGain = recentGains.reduce((a, b) => a + b, 0) / period;
            const avgLoss = recentLosses.reduce((a, b) => a + b, 0) / period;

            if (avgLoss === 0) return 100;
            const rs = avgGain / avgLoss;
            return 100 - (100 / (1 + rs));
        };

        const calcEMA = (closes, period = 10) => {
            if (closes.length < period) return 0;
            const recent = closes.slice(-period);
            return recent.reduce((a, b) => a + b, 0) / period;
        };

        const calcSupRes = (klines) => {
            if (!klines.length) return { sup: 0, res: 0 };
            const highs = klines.map(k => parseFloat(k[2]));
            const lows = klines.map(k => parseFloat(k[3]));
            return {
                sup: Math.min(...lows),
                res: Math.max(...highs)
            };
        };

        // ==========================
        // React ç»„ä»¶
        // ==========================
        function App() {
            const [marketData, setMarketData] = useState({});
            const [alerts, setAlerts] = useState([]);
            const [currentTime, setCurrentTime] = useState(new Date().toLocaleTimeString());
            const [audioEnabled, setAudioEnabled] = useState(false);
            
            // ä½¿ç”¨ ref æ¥å­˜å‚¨ä¸éœ€è¦è§¦å‘é‡æ¸²æŸ“çš„é€»è¾‘çŠ¶æ€
            const lastAlertTimeRef = useRef({}); 
            
            // è¯­éŸ³æ’­æŠ¥å‡½æ•°
            const speak = (text) => {
                if (!audioEnabled) return;
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = 1.2; // è¯­é€Ÿç¨å¿«
                window.speechSynthesis.speak(utterance);
            };

            // è·å– K çº¿æ•°æ®
            const fetchKlines = async () => {
                const newData = {};
                
                // å¹¶è¡Œè¯·æ±‚æ‰€æœ‰å‘¨æœŸ
                const promises = INTERVALS.map(async (interval) => {
                    try {
                        // æ³¨æ„ï¼šè¿™é‡Œç›´æ¥è°ƒç”¨å¸å®‰APIï¼Œå¦‚æœé‡åˆ° CORS é”™è¯¯ï¼Œè¯·å®‰è£… "Allow CORS" æ’ä»¶
                        // æˆ–è€…ä½¿ç”¨ https://api.binance.com/api/v3/klines
                        const res = await axios.get(`https://api.binance.com/api/v3/klines`, {
                            params: { symbol: CONFIG.SYMBOL, interval: interval, limit: 100 }
                        });
                        
                        const klines = res.data;
                        const closes = klines.map(k => parseFloat(k[4]));
                        const currentPrice = closes[closes.length - 1];
                        const { sup, res: resist } = calcSupRes(klines);
                        const rsi = calcRSI(closes);
                        const ema = calcEMA(closes);
                        
                        // è¶‹åŠ¿åˆ¤æ–­
                        const trend = currentPrice > ema ? "å¤šå¤´" : "ç©ºå¤´";

                        newData[interval] = {
                            price: currentPrice,
                            rsi: rsi,
                            support: sup,
                            resistance: resist,
                            ema: ema,
                            trend: trend
                        };
                    } catch (e) {
                        console.error(`Fetch error ${interval}:`, e);
                    }
                });

                await Promise.all(promises);
                if (Object.keys(newData).length > 0) {
                    setMarketData(newData);
                    checkSignals(newData);
                }
            };

            // ä¿¡å·æ£€æµ‹é€»è¾‘ (æ ¸å¿ƒæˆ˜æœ¯)
            const checkSignals = (data) => {
                const checkIntervals = ["1m", "3m", "5m"];
                
                checkIntervals.forEach(p => {
                    const d = data[p];
                    if (!d) return;

                    let sig = "";
                    // å¤šå•é€»è¾‘
                    if (Math.abs(d.price - d.support) <= CONFIG.PRICE_TOLERANCE && d.rsi > 30 && d.price > d.ema) {
                        sig = "å¤š";
                    }
                    // ç©ºå•é€»è¾‘
                    else if (Math.abs(d.price - d.resistance) <= CONFIG.PRICE_TOLERANCE && d.rsi < 70 && d.price < d.ema) {
                        sig = "ç©º";
                    }

                    if (sig) {
                        const key = `${p}_${sig}`;
                        const now = new Date();
                        const lastTime = lastAlertTimeRef.current[key];

                        // å†·å´æ—¶é—´æ£€æŸ¥
                        if (!lastTime || (now - lastTime) > (CONFIG.COOLDOWN_MINUTES * 60 * 1000)) {
                            lastAlertTimeRef.current[key] = now;
                            
                            // æˆ˜æœ¯ç‚¹ä½è®¡ç®—
                            let entry1, entry2, sl, tp;
                            if (sig === "å¤š") {
                                entry1 = d.price;
                                entry2 = d.support + 2;
                                sl = d.support - CONFIG.SL_OFFSET;
                            } else {
                                entry1 = d.price;
                                entry2 = d.resistance - 2;
                                sl = d.resistance + CONFIG.SL_OFFSET;
                            }
                            
                            const avgPrice = (entry1 * 0.3) + (entry2 * 0.7);
                            if (sig === "å¤š") {
                                tp = avgPrice + (avgPrice - sl) * CONFIG.PROFIT_RATIO;
                            } else {
                                tp = avgPrice - (sl - avgPrice) * CONFIG.PROFIT_RATIO;
                            }

                            const tag = p === "1m" ? "ä¾¦å¯Ÿå…µé¢„è­¦" : "å¤§éƒ¨é˜Ÿç¡®è®¤";
                            
                            const newAlert = {
                                time: now.toLocaleTimeString(),
                                type: `ã€åš${sig}ã€‘`,
                                period: p,
                                tag: tag,
                                entry1: entry1.toFixed(2),
                                entry2: entry2.toFixed(2),
                                sl: sl.toFixed(2),
                                tp: tp.toFixed(2)
                            };

                            setAlerts(prev => [newAlert, ...prev].slice(0, 50)); // ä¿ç•™æœ€è¿‘50æ¡

                            // è¯­éŸ³æ’­æŠ¥
                            const msg = `ç‹—å‰©ï¼Œ${tag}ã€‚${p}åš${sig}ï¼Œå¤´ä»“${entry1.toFixed(0)}ï¼Œæ­¢æŸ${sl.toFixed(0)}`;
                            speak(msg);
                        }
                    }
                });
            };

            // å®šæ—¶å™¨
            useEffect(() => {
                const timer = setInterval(() => {
                    setCurrentTime(new Date().toLocaleTimeString());
                    fetchKlines();
                }, CONFIG.SCAN_INTERVAL);
                
                fetchKlines(); // åˆæ¬¡æ‰§è¡Œ

                return () => clearInterval(timer);
            }, [audioEnabled]); // audioEnabled å˜åŒ–æ—¶ä¸éœ€è¦é‡ç½® timerï¼Œä½†ä¸ºäº†ç®€åŒ–é—­åŒ…é—®é¢˜è¿™é‡Œæš‚æ—¶ä¿ç•™

            return (
                <div className="max-w-5xl mx-auto p-4">
                    {/* Header */}
                    <div className="flex justify-between items-center mb-6 border-b border-gray-700 pb-4">
                        <div>
                            <h1 className="text-2xl font-bold text-yellow-400">ğŸ¶ ç‹—å‰©å…¨ç»´åº¦ä½œæˆ˜ç»ˆç«¯</h1>
                            <p className="text-sm text-gray-400">å½“å‰ç›‘æ§: {CONFIG.SYMBOL} | æ—¶é—´: {currentTime}</p>
                        </div>
                        <button 
                            onClick={() => setAudioEnabled(!audioEnabled)}
                            className={`px-4 py-2 rounded font-bold ${audioEnabled ? 'bg-green-600' : 'bg-red-600'}`}
                        >
                            {audioEnabled ? "ğŸ”Š è¯­éŸ³å·²å¼€å¯" : "ğŸ”‡ ç‚¹å‡»å¼€å¯è¯­éŸ³"}
                        </button>
                    </div>

                    {/* Data Table */}
                    <div className="bg-gray-800 rounded-lg overflow-hidden shadow-lg mb-8">
                        <table className="w-full text-left border-collapse">
                            <thead>
                                <tr className="bg-gray-900 text-gray-400">
                                    <th className="p-3">å‘¨æœŸ</th>
                                    <th className="p-3">ç°ä»·</th>
                                    <th className="p-3">æ”¯æ’‘(ä½)</th>
                                    <th className="p-3">å‹åŠ›(é«˜)</th>
                                    <th className="p-3">RSI</th>
                                    <th className="p-3">è¶‹åŠ¿</th>
                                    <th className="p-3">çŠ¶æ€</th>
                                </tr>
                            </thead>
                            <tbody>
                                {INTERVALS.map(p => {
                                    const d = marketData[p];
                                    if (!d) return <tr key={p}><td colSpan="7" className="p-3 text-center">åŠ è½½ä¸­...</td></tr>;
                                    
                                    const isNearSupport = Math.abs(d.price - d.support) <= CONFIG.PRICE_TOLERANCE;
                                    const isNearResist = Math.abs(d.price - d.resistance) <= CONFIG.PRICE_TOLERANCE;
                                    
                                    return (
                                        <tr key={p} className="border-b border-gray-700 hover:bg-gray-700">
                                            <td className="p-3 font-bold text-blue-300">{p}</td>
                                            <td className="p-3 text-yellow-300">{d.price.toFixed(2)}</td>
                                            <td className="p-3 text-green-400">{d.support.toFixed(2)}</td>
                                            <td className="p-3 text-red-400">{d.resistance.toFixed(2)}</td>
                                            <td className={`p-3 font-bold ${d.rsi > 70 ? 'text-red-500' : d.rsi < 30 ? 'text-green-500' : ''}`}>
                                                {d.rsi.toFixed(1)}
                                            </td>
                                            <td className={`p-3 ${d.trend === 'å¤šå¤´' ? 'up' : 'down'}`}>
                                                {d.trend === 'å¤šå¤´' ? 'ğŸ“ˆ å¤šå¤´' : 'ğŸ“‰ ç©ºå¤´'}
                                            </td>
                                            <td className="p-3">
                                                {isNearSupport && <span className="text-red-500 font-bold flash">ğŸ”¥ é€¼è¿‘æ”¯æ’‘</span>}
                                                {isNearResist && <span className="text-blue-400 font-bold flash">â„ï¸ é€¼è¿‘å‹åŠ›</span>}
                                            </td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>

                    {/* Alerts Log */}
                    <div>
                        <h2 className="text-xl font-bold mb-4 text-purple-400">ğŸš€ ä½œæˆ˜æŒ‡ä»¤æ±‡æ€»</h2>
                        <div className="space-y-3">
                            {alerts.length === 0 && <p className="text-gray-500">æš‚æ— ä½œæˆ˜æŒ‡ä»¤ï¼Œé™é»˜ä¾¦æŸ¥ä¸­...</p>}
                            {alerts.map((alert, idx) => (
                                <div key={idx} className="bg-gray-800 border-l-4 border-yellow-500 p-4 rounded shadow">
                                    <div className="flex justify-between items-start mb-2">
                                        <span className="font-mono text-gray-400">{alert.time}</span>
                                        <span className={`font-bold px-2 py-1 rounded text-sm ${alert.type.includes('å¤š') ? 'bg-green-900 text-green-300' : 'bg-red-900 text-red-300'}`}>
                                            {alert.period} {alert.type}
                                        </span>
                                    </div>
                                    <div className="text-lg font-bold mb-1">{alert.tag}</div>
                                    <div className="grid grid-cols-2 gap-4 text-sm text-gray-300">
                                        <div>
                                            <span className="block text-gray-500">å…¥åœºç‚¹ä½:</span>
                                            å¤´ä»“: <span className="text-white">{alert.entry1}</span> | 
                                            è¡¥ä»“: <span className="text-white">{alert.entry2}</span>
                                        </div>
                                        <div className="text-right">
                                            <span className="block text-gray-500">é£æ§:</span>
                                            æ­¢æŸ: <span className="text-red-400 font-bold">{alert.sl}</span> | 
                                            æ­¢ç›ˆ: <span className="text-green-400 font-bold">{alert.tp}</span>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>